name: Smart CI/CD

on:
  push:
    branches:
      - main  # Trigger only on main branch

jobs:
  smart-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the repo
      - name: Checkout Code
        uses: actions/checkout@v3

      # 2️⃣ Set up PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mysqli

# 3️⃣ Detect changed files
- name: Detect changed files
  id: changes
  run: |
    # Fetch full history to compare commits
    git fetch --unshallow || echo "Already full clone"

    # Check if previous commit exists, else deploy all files
    if git rev-parse HEAD~1 >/dev/null 2>&1; then
      CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
    else
      CHANGED_FILES=$(git ls-files)
    fi

    echo "All changed files: $CHANGED_FILES"

    # Filter deployable files (PHP, HTML, JS, CSS, images)
    DEPLOY_FILES=$(echo "$CHANGED_FILES" | grep -E '\.php$|\.html$|\.js$|\.css$|\.png$|\.jpg$|\.svg$' || true)
    echo "Deployable files: $DEPLOY_FILES"

    if [ -z "$DEPLOY_FILES" ]; then
      echo "no_deploy=true" >> $GITHUB_OUTPUT
    else
      echo "no_deploy=false" >> $GITHUB_OUTPUT


      # 4️⃣ Skip deployment if no real code changes
      - name: Skip if Only Comments or Docs
        if: env.CHANGED_FILES == ''
        run: |
          echo "No code changes detected. Skipping deployment."
          exit 0

      # 5️⃣ Deploy to EC2
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_KEY: ${{ secrets.EC2_KEY }}
        run: |
          echo "$EC2_KEY" > ec2_key.pem
          chmod 400 ec2_key.pem
          ssh -o StrictHostKeyChecking=no -i ec2_key.pem $EC2_USER@$EC2_HOST << 'EOF'
            cd /var/www/html/barbershop_management
            git pull origin main
            sudo systemctl restart apache2
          EOF
          rm -f ec2_key.pem
