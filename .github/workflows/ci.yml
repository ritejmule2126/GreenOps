name: GreenOps Smart CI/CD

on:
  push:
    branches:
      - main

jobs:
  smart-ci:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo with enough history for git diff
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 2  # Fetch last 2 commits for diff

      # 2️⃣ Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.1

      # 3️⃣ List all changed files (works now with shallow clone)
      - name: List changed files
        id: changes
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "Changed files detected:"
          echo "$CHANGED_FILES"

      # 4️⃣ PHP syntax check only if PHP files changed
      - name: PHP syntax check
        if: contains(env.CHANGED_FILES, '.php')
        run: |
          echo "PHP files changed. Running syntax check..."
          echo "$CHANGED_FILES" | grep ".php" | while read file; do
            php -l $file
          done

      # 5️⃣ Frontend lint only if HTML/CSS/JS changed
      - name: Frontend lint
        if: contains(env.CHANGED_FILES, '.html') || contains(env.CHANGED_FILES, '.css') || contains(env.CHANGED_FILES, '.js')
        run: |
          echo "Frontend files changed. Linter step (optional)"
          echo "$CHANGED_FILES" | grep -E ".html|.css|.js"

      # 6️⃣ Deploy updated assets/images/config if changed
      - name: Deploy updated assets
        if: contains(env.CHANGED_FILES, '.png') || contains(env.CHANGED_FILES, '.jpg') || contains(env.CHANGED_FILES, '.svg') || contains(env.CHANGED_FILES, '.env')
        run: |
          echo "Assets/images/config changed. Deploy or copy them as needed"
          echo "$CHANGED_FILES" | grep -E ".png|.jpg|.svg|.env"

      # 7️⃣ Test PHP server (only if PHP files changed)
      - name: Test PHP server
        if: contains(env.CHANGED_FILES, '.php')
        run: |
          php -S localhost:8083 -t . &
          sleep 5
          curl -s http://localhost:8083 > /dev/null
          echo "PHP server test successful"

