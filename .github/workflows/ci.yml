name: GreenOps Smart CI/CD

on:
  push:
    branches:
      - main
    # Trigger only if relevant files are changed
    paths:
      - '**.php'
      - '**.html'
      - '**.css'
      - '**.js'
      - '**.png'
      - '**.jpg'
      - '**.svg'
      - '.env'

jobs:
  smart-ci:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.1

      # 3️⃣ List all changed files
      - name: List changed files
        id: changes
        run: |
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "Changed files detected:"
          echo "$CHANGED_FILES"

      # 4️⃣ Run PHP syntax check only if PHP files changed
      - name: PHP syntax check
        if: contains(env.CHANGED_FILES, '.php')
        run: |
          echo "PHP files changed. Running syntax check..."
          echo "$CHANGED_FILES" | grep ".php" | while read file; do
            php -l $file
          done

      # 5️⃣ Lint frontend files if HTML/CSS/JS changed
      - name: Frontend lint
        if: contains(env.CHANGED_FILES, '.html') || contains(env.CHANGED_FILES, '.css') || contains(env.CHANGED_FILES, '.js')
        run: |
          echo "Frontend files changed. You can add linter commands here."
          echo "$CHANGED_FILES" | grep -E ".html|.css|.js"

      # 6️⃣ Optional: Deploy updated assets/images if they changed
      - name: Deploy updated assets
        if: contains(env.CHANGED_FILES, '.png') || contains(env.CHANGED_FILES, '.jpg') || contains(env.CHANGED_FILES, '.svg') || contains(env.CHANGED_FILES, '.env')
        run: |
          echo "Assets/images/config changed. Deploy or copy them as needed."
          echo "$CHANGED_FILES" | grep -E ".png|.jpg|.svg|.env"

      # 7️⃣ Start PHP server and run simple test only if PHP files changed
      - name: Test PHP server
        if: contains(env.CHANGED_FILES, '.php')
        run: |
          php -S localhost:8083 -t . &
          sleep 5
          curl -s http://localhost:8083 > /dev/null
          echo "PHP server test successful"

      # 8️⃣ Build Docker only if PHP/backend files changed
      - name: Build Docker (optional)
        if: contains(env.CHANGED_FILES, '.php') || contains(env.CHANGED_FILES, '.env')
        run: |
          echo "Backend files changed. Building Docker image..."
          docker build -t greenops-barbershop .
